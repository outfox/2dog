<Project>
    <!--
      TwoDog Linux x64 Meta Package Targets

      This meta package owns all native libgodot.so copy logic.

      Behaviour:
      - When consumed as a NuGet package, it locates the appropriate libgodot.so
        from the variant dependency packages (release, debug, editor) in the
        global NuGet package cache and copies it to the output/publish directory.
      - When used via ProjectReference in this repository, it falls back to the
        locally built Godot binaries in godot/bin.

      Configuration mapping:
      - Debug (or unspecified): prefer editor build (TOOLS_ENABLED)
      - Release: prefer template_release build
    -->

    <!-- Discover package version from this .targets location -->
    <!-- MSBuildThisFileDirectory = .../packages/2dog.linux-x64/0.1.0-pre/build/ (with trailing slash) -->
    <!-- TrimEnd the trailing slash, then get parent directory name -->
    <PropertyGroup>
        <_TwoDogLinuxX64TargetsDir>$(MSBuildThisFileDirectory.TrimEnd('\').TrimEnd('/'))</_TwoDogLinuxX64TargetsDir>
        <TwoDogLinuxX64PackageVersion Condition="'$(TwoDogLinuxX64PackageVersion)' == ''">$([System.IO.Path]::GetFileName($([System.IO.Path]::GetDirectoryName('$(_TwoDogLinuxX64TargetsDir)'))))</TwoDogLinuxX64PackageVersion>
    </PropertyGroup>

    <PropertyGroup>
        <!-- Variant package paths in the NuGet global packages folder -->
        <!-- $(NuGetPackageRoot) is set by NuGet restore and points to the packages cache -->
        <TwoDogLinuxX64ReleasePackage>$(NuGetPackageRoot)/2dog.linux-x64.release/$(TwoDogLinuxX64PackageVersion)/runtimes/linux-x64/native/libgodot.so</TwoDogLinuxX64ReleasePackage>
        <TwoDogLinuxX64DebugPackage>$(NuGetPackageRoot)/2dog.linux-x64.debug/$(TwoDogLinuxX64PackageVersion)/runtimes/linux-x64/native/libgodot.so</TwoDogLinuxX64DebugPackage>
        <TwoDogLinuxX64EditorPackage>$(NuGetPackageRoot)/2dog.linux-x64.editor/$(TwoDogLinuxX64PackageVersion)/runtimes/linux-x64/native/libgodot.so</TwoDogLinuxX64EditorPackage>

        <!-- Local development paths (fallback for ProjectReference builds) -->
        <TwoDogLocalGodotBin Condition="'$(TwoDogLocalGodotBin)' == ''">$(MSBuildThisFileDirectory)../../../godot/bin/</TwoDogLocalGodotBin>
        <TwoDogLinuxX64ReleaseLocal>$(TwoDogLocalGodotBin)libgodot.linuxbsd.template_release.x86_64.shared_library.so</TwoDogLinuxX64ReleaseLocal>
        <TwoDogLinuxX64DebugLocal>$(TwoDogLocalGodotBin)libgodot.linuxbsd.template_debug.dev.x86_64.shared_library.so</TwoDogLinuxX64DebugLocal>
        <TwoDogLinuxX64EditorLocal>$(TwoDogLocalGodotBin)libgodot.linuxbsd.editor.dev.x86_64.shared_library.so</TwoDogLinuxX64EditorLocal>
    </PropertyGroup>

    <PropertyGroup Condition="'$(Configuration)' == 'Debug' Or '$(Configuration)' == ''">
        <TwoDogLinuxX64PreferredVariant Condition="'$(TwoDogLinuxX64PreferredVariant)' == ''">editor</TwoDogLinuxX64PreferredVariant>
    </PropertyGroup>
    <PropertyGroup Condition="'$(Configuration)' == 'Release'">
        <TwoDogLinuxX64PreferredVariant Condition="'$(TwoDogLinuxX64PreferredVariant)' == ''">release</TwoDogLinuxX64PreferredVariant>
    </PropertyGroup>
    <PropertyGroup>
        <TwoDogLinuxX64PreferredVariant Condition="'$(TwoDogLinuxX64PreferredVariant)' == ''">release</TwoDogLinuxX64PreferredVariant>
    </PropertyGroup>

    <PropertyGroup>
        <TwoDogLinuxX64VariantPackagePath Condition="'$(TwoDogLinuxX64PreferredVariant)' == 'editor'">$(TwoDogLinuxX64EditorPackage)</TwoDogLinuxX64VariantPackagePath>
        <TwoDogLinuxX64VariantPackagePath Condition="'$(TwoDogLinuxX64PreferredVariant)' == 'debug'">$(TwoDogLinuxX64DebugPackage)</TwoDogLinuxX64VariantPackagePath>
        <TwoDogLinuxX64VariantPackagePath Condition="'$(TwoDogLinuxX64PreferredVariant)' == 'release'">$(TwoDogLinuxX64ReleasePackage)</TwoDogLinuxX64VariantPackagePath>

        <TwoDogLinuxX64VariantLocalPath Condition="'$(TwoDogLinuxX64PreferredVariant)' == 'editor'">$(TwoDogLinuxX64EditorLocal)</TwoDogLinuxX64VariantLocalPath>
        <TwoDogLinuxX64VariantLocalPath Condition="'$(TwoDogLinuxX64PreferredVariant)' == 'debug'">$(TwoDogLinuxX64DebugLocal)</TwoDogLinuxX64VariantLocalPath>
        <TwoDogLinuxX64VariantLocalPath Condition="'$(TwoDogLinuxX64PreferredVariant)' == 'release'">$(TwoDogLinuxX64ReleaseLocal)</TwoDogLinuxX64VariantLocalPath>
    </PropertyGroup>

    <PropertyGroup>
        <TwoDogLinuxX64NativeLib Condition="'$(TwoDogLinuxX64VariantPackagePath)' != '' And Exists('$(TwoDogLinuxX64VariantPackagePath)')">$(TwoDogLinuxX64VariantPackagePath)</TwoDogLinuxX64NativeLib>
        <TwoDogLinuxX64NativeLib Condition="'$(TwoDogLinuxX64NativeLib)' == '' And '$(TwoDogLinuxX64VariantLocalPath)' != '' And Exists('$(TwoDogLinuxX64VariantLocalPath)')">$(TwoDogLinuxX64VariantLocalPath)</TwoDogLinuxX64NativeLib>
    </PropertyGroup>

    <!-- Copy native library to output on build (Linux only) -->
    <Target Name="TwoDogLinuxX64CopyNatives"
            AfterTargets="Build"
            Condition="'$(DesignTimeBuild)' != 'true' And $([MSBuild]::IsOSPlatform('Linux')) And '$(TwoDogLinuxX64NativeLib)' != '' And Exists('$(TwoDogLinuxX64NativeLib)')">
        <Copy SourceFiles="$(TwoDogLinuxX64NativeLib)"
              DestinationFiles="$(OutputPath)libgodot.so"
              SkipUnchangedFiles="true"/>
        <Message Importance="normal" Text="TwoDog: Copied Linux x64 $(TwoDogLinuxX64PreferredVariant) native library to $(OutputPath)"/>
    </Target>

    <!-- Copy native library on publish (when targeting Linux) -->
    <Target Name="TwoDogLinuxX64PublishNatives"
            AfterTargets="Publish"
            Condition="'$(DesignTimeBuild)' != 'true' And '$(RuntimeIdentifier)' != '' And $([System.String]::Copy('$(RuntimeIdentifier)').StartsWith('linux')) And '$(TwoDogLinuxX64NativeLib)' != '' And Exists('$(TwoDogLinuxX64NativeLib)')">
        <Copy SourceFiles="$(TwoDogLinuxX64NativeLib)"
              DestinationFiles="$(PublishDir)libgodot.so"
              SkipUnchangedFiles="true"/>
        <Message Importance="high" Text="TwoDog: Published Linux x64 $(TwoDogLinuxX64PreferredVariant) native library to $(PublishDir)"/>
    </Target>
</Project>
