<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <OutputType>Library</OutputType>
    <TargetFramework>net8.0</TargetFramework>
    <IsTrimmable>true</IsTrimmable>
    <VerifyReferenceTrimCompatibility>true</VerifyReferenceTrimCompatibility>
  </PropertyGroup>

  <!-- Programming & Linkage Characteristics -->
  <PropertyGroup>
    <RootNamespace>twodog</RootNamespace>
    <Nullable>enable</Nullable>
    <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
  </PropertyGroup>

  <!-- NuGet Package Metadata -->
  <PropertyGroup>
    <PackageId>twodog</PackageId>
    <Version>0.1.0-pre</Version>
    <Authors>2dog contributors</Authors>
    <Description>Embed Godot engine in your .NET applications. Bundles GodotSharp API assemblies and native libgodot libraries.</Description>
    <PackageLicenseExpression>MIT</PackageLicenseExpression>
    <GeneratePackageOnBuild>true</GeneratePackageOnBuild>
    <IncludeSymbols>true</IncludeSymbols>
    <SymbolPackageFormat>snupkg</SymbolPackageFormat>
    <!-- Suppress NU5100: GodotSharp API DLLs and native libs are intentionally in contentFiles/runtimes, not lib -->
    <NoWarn>$(NoWarn);NU5100</NoWarn>
  </PropertyGroup>

  <PropertyGroup>
    <GodotProjectDir>$(MSBuildProjectDirectory)/../project/</GodotProjectDir>
    <GodotBinDir>$(MSBuildProjectDirectory)/../godot/bin/</GodotBinDir>
  </PropertyGroup>
  
  <!-- Detect current OS for development builds -->
  <PropertyGroup>
    <IsLinux Condition="'$(IsLinux)' == '' and $([System.Runtime.InteropServices.RuntimeInformation]::IsOSPlatform($([System.Runtime.InteropServices.OSPlatform]::Linux)))">true</IsLinux>
    <IsWindows Condition="'$(IsWindows)' == '' and $([System.Runtime.InteropServices.RuntimeInformation]::IsOSPlatform($([System.Runtime.InteropServices.OSPlatform]::Windows)))">true</IsWindows>
    <IsOSX Condition="'$(IsOSX)' == '' and $([System.Runtime.InteropServices.RuntimeInformation]::IsOSPlatform($([System.Runtime.InteropServices.OSPlatform]::OSX)))">true</IsOSX>
  </PropertyGroup>

  <!-- Package reference for compile-time API -->
  <ItemGroup>
    <PackageReference Version="4.6.0-beta" Include="GodotSharp" />
  </ItemGroup>

  <!-- Include MSBuild targets in the package -->
  <ItemGroup>
    <None Include="build\twodog.targets" Pack="true" PackagePath="build\" />
    <None Include="buildTransitive\twodog.targets" Pack="true" PackagePath="buildTransitive\" />
  </ItemGroup>

  <!-- Include GodotSharp API assemblies in the package (both Debug and Release) -->
  <ItemGroup>
    <Content Include="$(GodotBinDir)GodotSharp\Api\Debug\**\*.*"
             Pack="true"
             PackagePath="contentFiles\any\any\GodotSharp\Api\Debug\"
             CopyToOutputDirectory="Never" />
    <Content Include="$(GodotBinDir)GodotSharp\Api\Release\**\*.*"
             Pack="true"
             PackagePath="contentFiles\any\any\GodotSharp\Api\Release\"
             CopyToOutputDirectory="Never" />
  </ItemGroup>

  <!-- Include native libraries in runtimes folder for NuGet automatic RID-based resolution -->
  <ItemGroup>
    <!-- Windows x64 -->
    <Content Include="$(GodotBinDir)godot.windows.editor.dev.x86_64.shared_library.dll"
             Pack="true"
             PackagePath="runtimes\win-x64\native\libgodot.dll"
             Link="runtimes\win-x64\native\libgodot.dll"
             CopyToOutputDirectory="Never" />
    <!-- Linux x64 (if exists) -->
    <Content Include="$(GodotBinDir)libgodot.linuxbsd.editor.dev.x86_64.shared_library.so"
             Pack="true"
             PackagePath="runtimes\linux-x64\native\libgodot.so"
             Link="runtimes\linux-x64\native\libgodot.so"
             CopyToOutputDirectory="Never"
             Condition="Exists('$(GodotBinDir)libgodot.linuxbsd.editor.dev.x86_64.shared_library.so')" />
    <!-- macOS x64 (if exists) -->
    <Content Include="$(GodotBinDir)libgodot.macos.editor.dev.x86_64.shared_library.dylib"
             Pack="true"
             PackagePath="runtimes\osx-x64\native\libgodot.dylib"
             Link="runtimes\osx-x64\native\libgodot.dylib"
             CopyToOutputDirectory="Never"
             Condition="Exists('$(GodotBinDir)libgodot.macos.editor.dev.x86_64.shared_library.dylib')" />
  </ItemGroup>

  <!-- For local development: Copy current platform's native lib to output (not included in package) -->
  <ItemGroup Condition="'$(RuntimeIdentifier)' == ''">
    <Content Include="$(GodotBinDir)libgodot.linuxbsd.editor.dev.x86_64.shared_library.so"
             Pack="false"
             Link="libgodot.so"
             CopyToOutputDirectory="PreserveNewest"
             Condition="'$(IsLinux)' == 'true' And Exists('$(GodotBinDir)libgodot.linuxbsd.editor.dev.x86_64.shared_library.so')" />
    <Content Include="$(GodotBinDir)godot.windows.editor.dev.x86_64.shared_library.dll"
             Pack="false"
             Link="libgodot.dll"
             CopyToOutputDirectory="PreserveNewest"
             Condition="'$(IsWindows)' == 'true'" />
    <Content Include="$(GodotBinDir)libgodot.macos.editor.dev.x86_64.shared_library.dylib"
             Pack="false"
             Link="libgodot.dylib"
             CopyToOutputDirectory="PreserveNewest"
             Condition="'$(IsOSX)' == 'true' And Exists('$(GodotBinDir)libgodot.macos.editor.dev.x86_64.shared_library.dylib')" />
  </ItemGroup>

  <!-- For Publish: Copy only the target RID's lib (not included in package) -->
  <ItemGroup Condition="'$(RuntimeIdentifier)' != ''">
    <Content Include="$(GodotBinDir)libgodot.linuxbsd.editor.dev.x86_64.shared_library.so"
             Pack="false"
             Link="libgodot.so"
             CopyToOutputDirectory="PreserveNewest"
             Condition="$(RuntimeIdentifier.StartsWith('linux')) And Exists('$(GodotBinDir)libgodot.linuxbsd.editor.dev.x86_64.shared_library.so')" />
    <Content Include="$(GodotBinDir)godot.windows.editor.dev.x86_64.shared_library.dll"
             Pack="false"
             Link="libgodot.dll"
             CopyToOutputDirectory="PreserveNewest"
             Condition="$(RuntimeIdentifier.StartsWith('win'))" />
    <Content Include="$(GodotBinDir)libgodot.macos.editor.dev.x86_64.shared_library.dylib"
             Pack="false"
             Link="libgodot.dylib"
             CopyToOutputDirectory="PreserveNewest"
             Condition="$(RuntimeIdentifier.StartsWith('osx')) And Exists('$(GodotBinDir)libgodot.macos.editor.dev.x86_64.shared_library.dylib')" />
  </ItemGroup>

  <!-- For local development: Copy GodotSharp API assemblies to output -->
  <Target Name="CopyGodotApiAssembliesForLocalDev" AfterTargets="Build" Condition="'$(DesignTimeBuild)' != 'true'">
    <PropertyGroup>
      <TwoDogGodotApiConfiguration Condition="'$(Configuration)' == 'Release'">Release</TwoDogGodotApiConfiguration>
      <TwoDogGodotApiConfiguration Condition="'$(TwoDogGodotApiConfiguration)' == ''">Debug</TwoDogGodotApiConfiguration>
      <GodotApiDestPath>$(OutputPath)GodotSharp\Api\$(TwoDogGodotApiConfiguration)\</GodotApiDestPath>
    </PropertyGroup>

    <ItemGroup>
      <GodotApiFiles Include="$(GodotBinDir)GodotSharp\Api\$(TwoDogGodotApiConfiguration)\**\*.*" />
    </ItemGroup>

    <MakeDir Directories="$(GodotApiDestPath)" />
    <Copy SourceFiles="@(GodotApiFiles)"
          DestinationFolder="$(GodotApiDestPath)%(RecursiveDir)"
          SkipUnchangedFiles="true" />
  </Target>

  <Target Name="DeepClean" AfterTargets="Clean">
    <RemoveDir Directories="$(BaseIntermediateOutputPath)" />
    <RemoveDir Directories="$(BaseOutputPath)" />
  </Target>
</Project>
