<Project>
    <!--
      TwoDog MSBuild Targets

      Handles copying GodotPlugins assemblies to output directory.
      GodotSharp and Godot.SourceGenerators are bundled in the 2dog package
      (lib/net8.0/ and analyzers/dotnet/cs/ respectively).

      Native libraries are provided by separate platform-specific packages:
        - 2dog.win-x64 / 2dog.linux-x64 / 2dog.osx-arm64: template_release builds
        - 2dog.win-x64.debug / 2dog.linux-x64.debug / 2dog.osx-arm64.debug: template_debug builds
        - 2dog.win-x64.editor / 2dog.linux-x64.editor / 2dog.osx-arm64.editor: editor builds

      When you install the 2dog package from NuGet, the release variant platform
      packages above are referenced automatically. For debug/editor variants you
      can reference the corresponding platform packages explicitly.

      Configurable Properties (in consuming project):
        - TwoDogVariant: 'release' (default), 'debug', or 'editor'
          Controls how GodotPlugins assemblies are laid out.
        - TwoDogBuildType: 'template_release', 'template_debug', or 'editor'
          Advanced: override the build type used for API placement.
    -->

    <!-- ============================================ -->
    <!-- GodotProjectDir Assembly Metadata             -->
    <!-- ============================================ -->
    <!-- Embed GodotProjectDir as assembly metadata so twodog can resolve the
         Godot project directory at runtime (via Engine.ResolveProjectDir()).
         Consumers just need <GodotProjectDir> in their .csproj. -->
    <ItemGroup Condition="'$(GodotProjectDir)' != ''">
        <AssemblyAttribute Include="System.Reflection.AssemblyMetadataAttribute">
            <_Parameter1>GodotProjectDir</_Parameter1>
            <_Parameter2>$([System.IO.Path]::GetFullPath('$(GodotProjectDir)', '$(MSBuildProjectDirectory)'))</_Parameter2>
        </AssemblyAttribute>
    </ItemGroup>

    <!-- ============================================ -->
    <!-- Variant & Build Type Configuration           -->
    <!-- ============================================ -->
    <PropertyGroup>
        <!-- Variant: release (default), debug, or editor -->
        <TwoDogVariant Condition="'$(TwoDogVariant)' == ''">release</TwoDogVariant>

        <!-- Map variant to build type for API assembly handling -->
        <TwoDogBuildType Condition="'$(TwoDogBuildType)' == '' And '$(TwoDogVariant)' == 'release'">template_release</TwoDogBuildType>
        <TwoDogBuildType Condition="'$(TwoDogBuildType)' == '' And '$(TwoDogVariant)' == 'debug'">template_debug</TwoDogBuildType>
        <TwoDogBuildType Condition="'$(TwoDogBuildType)' == '' And '$(TwoDogVariant)' == 'editor'">editor</TwoDogBuildType>
        <TwoDogBuildType Condition="'$(TwoDogBuildType)' == ''">template_release</TwoDogBuildType>

        <!-- Package root (for locating contentFiles when used as a NuGet package) -->
        <TwoDogPackageRoot Condition="'$(TwoDogPackageRoot)' == ''">$(MSBuildThisFileDirectory)../</TwoDogPackageRoot>
    </PropertyGroup>

    <!-- ============================================ -->
    <!-- GodotPlugins Configuration                   -->
    <!-- ============================================ -->
    <PropertyGroup>
        <!--
          GodotPlugins placement depends on build type:
          - Editor builds (TOOLS_ENABLED): Nested GodotSharp/Api/Debug/ structure
          - Template builds (LIBGODOT_HOSTFXR): Flat structure in output dir
        -->

        <!-- 1. GODOTSHARP_DIR env var (highest priority) -->
        <TwoDogGodotApiSourcePath Condition="'$(GODOTSHARP_DIR)' != '' And Exists('$(GODOTSHARP_DIR)/GodotPlugins.dll')">$(GODOTSHARP_DIR)</TwoDogGodotApiSourcePath>

        <!-- 2. Path within the NuGet package (for package consumers) -->
        <TwoDogGodotApiSourcePath_Package>$(TwoDogPackageRoot)build/api/</TwoDogGodotApiSourcePath_Package>
        <TwoDogGodotApiSourcePath Condition="'$(TwoDogGodotApiSourcePath)' == '' And Exists('$(TwoDogGodotApiSourcePath_Package)GodotPlugins.dll')">$(TwoDogGodotApiSourcePath_Package)</TwoDogGodotApiSourcePath>

        <!-- 3. Path for project reference consumers (source checkout) -->
        <TwoDogGodotApiSourcePath_ProjectRef>$(MSBuildThisFileDirectory)../../godot/bin/GodotSharp/Api/Debug/</TwoDogGodotApiSourcePath_ProjectRef>
        <TwoDogGodotApiSourcePath Condition="'$(TwoDogGodotApiSourcePath)' == '' And Exists('$(TwoDogGodotApiSourcePath_ProjectRef)')">$(TwoDogGodotApiSourcePath_ProjectRef)</TwoDogGodotApiSourcePath>

        <!--
          Destination path depends on build type:
          - Editor builds: GodotSharp/Api/Debug/ subdirectory (required by TOOLS_ENABLED native code)
          - template_debug: GodotSharp/Api/Debug/ subdirectory (same as editor)
          - template_release: Flat in output directory (LIBGODOT_HOSTFXR only)
        -->
        <TwoDogGodotApiDestSubdir Condition="'$(TwoDogBuildType)' == 'editor'">GodotSharp/Api/Debug/</TwoDogGodotApiDestSubdir>
        <TwoDogGodotApiDestSubdir Condition="'$(TwoDogBuildType)' == 'template_debug'">GodotSharp/Api/Debug/</TwoDogGodotApiDestSubdir>
        <TwoDogGodotApiDestSubdir Condition="'$(TwoDogBuildType)' == 'template_release'"></TwoDogGodotApiDestSubdir>
        <TwoDogGodotApiDestSubdir Condition="'$(TwoDogGodotApiDestSubdir)' == ''"></TwoDogGodotApiDestSubdir>
    </PropertyGroup>

    <!-- ============================================ -->
    <!-- Target: Copy GodotPlugins to Output          -->
    <!-- ============================================ -->
    <Target Name="TwoDogCopyGodotApi"
            AfterTargets="Build"
            Condition="'$(DesignTimeBuild)' != 'true' And '$(TwoDogGodotApiSourcePath)' != '' And Exists('$(TwoDogGodotApiSourcePath)')">

        <PropertyGroup>
            <TwoDogGodotApiDestPath>$(OutputPath)$(TwoDogGodotApiDestSubdir)</TwoDogGodotApiDestPath>
        </PropertyGroup>

        <ItemGroup>
            <TwoDogGodotApiFiles Include="$(TwoDogGodotApiSourcePath)GodotPlugins.dll"/>
            <TwoDogGodotApiFiles Include="$(TwoDogGodotApiSourcePath)GodotPlugins.pdb" Condition="Exists('$(TwoDogGodotApiSourcePath)GodotPlugins.pdb')"/>
            <TwoDogGodotApiFiles Include="$(TwoDogGodotApiSourcePath)GodotPlugins.runtimeconfig.json" Condition="Exists('$(TwoDogGodotApiSourcePath)GodotPlugins.runtimeconfig.json')"/>
        </ItemGroup>

        <MakeDir Directories="$(TwoDogGodotApiDestPath)" Condition="'$(TwoDogGodotApiDestSubdir)' != ''"/>
        <Copy SourceFiles="@(TwoDogGodotApiFiles)"
              DestinationFolder="$(TwoDogGodotApiDestPath)"
              SkipUnchangedFiles="true"/>

        <Message Importance="normal" Text="TwoDog: Copied GodotPlugins to $(TwoDogGodotApiDestPath)"/>
    </Target>

    <!-- ============================================ -->
    <!-- Target: Publish GodotPlugins                 -->
    <!-- ============================================ -->
    <Target Name="TwoDogPublishGodotApi"
            AfterTargets="Publish"
            Condition="'$(DesignTimeBuild)' != 'true' And '$(TwoDogGodotApiSourcePath)' != '' And Exists('$(TwoDogGodotApiSourcePath)')">

        <PropertyGroup>
            <TwoDogGodotApiPublishDestPath>$(PublishDir)$(TwoDogGodotApiDestSubdir)</TwoDogGodotApiPublishDestPath>
        </PropertyGroup>

        <ItemGroup>
            <TwoDogGodotApiFilesForPublish Include="$(TwoDogGodotApiSourcePath)GodotPlugins.dll"/>
            <TwoDogGodotApiFilesForPublish Include="$(TwoDogGodotApiSourcePath)GodotPlugins.pdb" Condition="Exists('$(TwoDogGodotApiSourcePath)GodotPlugins.pdb')"/>
            <TwoDogGodotApiFilesForPublish Include="$(TwoDogGodotApiSourcePath)GodotPlugins.runtimeconfig.json" Condition="Exists('$(TwoDogGodotApiSourcePath)GodotPlugins.runtimeconfig.json')"/>
        </ItemGroup>

        <MakeDir Directories="$(TwoDogGodotApiPublishDestPath)" Condition="'$(TwoDogGodotApiDestSubdir)' != ''"/>
        <Copy SourceFiles="@(TwoDogGodotApiFilesForPublish)"
              DestinationFolder="$(TwoDogGodotApiPublishDestPath)"
              SkipUnchangedFiles="true"/>

        <Message Importance="high" Text="TwoDog: Published GodotPlugins to $(TwoDogGodotApiPublishDestPath)"/>
    </Target>

</Project>
